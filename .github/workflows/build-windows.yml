name: Build Windows Release

on:
  push:
    branches: [ master, main ]
    tags:
      - 'v*'
  pull_request:
    branches: [ master, main ]
  workflow_dispatch:
    inputs:
      build_type:
        description: 'Build type'
        required: true
        default: 'release'
        type: choice
        options:
          - release
          - debug

jobs:
  build-windows:
    runs-on: windows-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        fetch-depth: 0

    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'
        cache: 'pip'

    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install pyinstaller==5.13.2
        if (Test-Path requirements.txt) {
          pip install -r requirements.txt
        } else {
          pip install fastapi uvicorn jinja2 python-multipart
        }

    - name: Generate artifact name
      id: artifact
      shell: pwsh
      run: |
        $platform = "windows"
        $arch = "amd64"

        # Determine version based on event type
        if ("${{ github.event_name }}" -eq "pull_request") {
          $version = "${{ github.sha }}".Substring(0, 7)
        } elseif ("${{ github.ref }}" -like "refs/tags/v*") {
          $version = "${{ github.ref }}".Replace("refs/tags/", "")
        } else {
          $version = Get-Date -Format "yyyyMMdd"
        }

        # Determine build type
        $buildType = "${{ github.event.inputs.build_type }}"
        if ([string]::IsNullOrEmpty($buildType)) {
          $buildType = "release"
        }

        # Generate names
        $baseName = "lan-auth-gate-$platform-$arch"

        if ($buildType -eq "debug") {
          $artifactName = "$baseName-debug-$version"
        } else {
          $artifactName = "$baseName-$version"
        }

        echo "artifact-name=$artifactName" >> $env:GITHUB_OUTPUT
        echo "artifact-name-zip=$artifactName.zip" >> $env:GITHUB_OUTPUT
        echo "version=$version" >> $env:GITHUB_OUTPUT
        echo "build-type=$buildType" >> $env:GITHUB_OUTPUT

        Write-Host "Artifact name: $artifactName"
        Write-Host "Version: $version"
        Write-Host "Build type: $buildType"

    - name: Build with PyInstaller
      shell: pwsh
      run: |
        # Create logs directory
        New-Item -ItemType Directory -Path "logs" -Force

        # Build executable
        pyinstaller --onefile --console `
          --add-data "static;static" `
          --add-data "templates;templates" `
          -F main.py

        if ($LASTEXITCODE -ne 0) {
          Write-Host "PyInstaller build failed!"
          exit 1
        }

    - name: Create distribution package
      shell: pwsh
      run: |
        # Create directory structure
        $distDir = "dist/windows"
        $appDir = "$distDir/app"

        New-Item -ItemType Directory -Path "$appDir/static" -Force
        New-Item -ItemType Directory -Path "$appDir/templates" -Force
        New-Item -ItemType Directory -Path "$appDir/logs" -Force
        New-Item -ItemType Directory -Path "$distDir/nssm/win64" -Force
        New-Item -ItemType Directory -Path "$distDir/nssm/win32" -Force

        # Copy executable
        Copy-Item "dist/main.exe" "$appDir/LanAuthGate.exe"

        # Copy static files and templates
        Copy-Item -Recurse -Force "static/*" "$appDir/static"
        Copy-Item -Recurse -Force "templates/*" "$appDir/templates"

        # Create PowerShell deployment script
        $deployScript = @'
# LanAuthGate PowerShell Deployment Script
param(
    [switch]$Uninstall = $false,
    [string]$ServiceName = "LanAuthGate",
    [string]$InstallPath = "$PSScriptRoot\app"
)

$ErrorActionPreference = "Stop"

function Test-Administrator {
    $currentUser = [Security.Principal.WindowsIdentity]::GetCurrent()
    $principal = New-Object Security.Principal.WindowsPrincipal($currentUser)
    return $principal.IsInRole([Security.Principal.WindowsBuiltInRole]::Administrator)
}

function Deploy-Service {
    if (!(Test-Administrator)) {
        Write-Host "‚ùå Please run this script as Administrator!" -ForegroundColor Red
        exit 1
    }

    $exePath = Join-Path $InstallPath "LanAuthGate.exe"
    $nssmPath = Join-Path $PSScriptRoot "nssm\win64\nssm.exe"

    if (!(Test-Path $exePath)) {
        Write-Host "‚ùå Executable not found: $exePath" -ForegroundColor Red
        exit 1
    }

    # Download NSSM if not present
    if (!(Test-Path $nssmPath)) {
        Write-Host "üì• Downloading NSSM..." -ForegroundColor Yellow
        $nssmUrl = "https://nssm.cc/ci/nssm-2.24-101-g892929d.zip"
        $tempZip = "$env:TEMP\nssm.zip"

        try {
            Invoke-WebRequest -Uri $nssmUrl -OutFile $tempZip -UseBasicParsing
            Expand-Archive -Path $tempZip -DestinationPath "$env:TEMP\nssm" -Force
            Copy-Item "$env:TEMP\nssm\nssm-2.24-101-g892929d\win64\nssm.exe" $nssmPath
            Remove-Item $tempZip -Force
        } catch {
            Write-Host "‚ùå Failed to download NSSM: $_" -ForegroundColor Red
            exit 1
        }
    }

    # Remove existing service
    sc.exe query $ServiceName >$null 2>&1
    if ($LASTEXITCODE -eq 0) {
        Write-Host "‚ö†Ô∏è Service already exists, removing..." -ForegroundColor Yellow
        & $nssmPath stop $ServiceName confirm
        Start-Sleep -Seconds 3
        & $nssmPath remove $ServiceName confirm
        Start-Sleep -Seconds 2
    }

    # Install service
    Write-Host "üõ†Ô∏è Installing service..." -ForegroundColor Yellow
    & $nssmPath install $ServiceName $exePath

    if ($LASTEXITCODE -ne 0) {
        Write-Host "‚ùå Service installation failed!" -ForegroundColor Red
        exit 1
    }

    # Configure service
    Write-Host "‚öôÔ∏è Configuring service..." -ForegroundColor Yellow
    & $nssmPath set $ServiceName DisplayName "LanAuthGate API Manager"
    & $nssmPath set $ServiceName Description "API Authorization Manager and Monitoring System"
    & $nssmPath set $ServiceName Start SERVICE_AUTO_START
    & $nssmPath set $ServiceName AppDirectory $InstallPath
    & $nssmPath set $ServiceName AppStdout (Join-Path $InstallPath "service.log")
    & $nssmPath set $ServiceName AppStderr (Join-Path $InstallPath "service_error.log")
    & $nssmPath set $ServiceName AppRotateFiles 1
    & $nssmPath set $ServiceName AppRotateOnline 1
    & $nssmPath set $ServiceName AppRotateSeconds 86400
    & $nssmPath set $ServiceName AppRotateBytes 10485760

    # Start service
    Write-Host "üöÄ Starting service..." -ForegroundColor Yellow
    & $nssmPath start $ServiceName

    Start-Sleep -Seconds 5

    # Check status
    sc.exe query $ServiceName | findstr "RUNNING" >$null
    if ($LASTEXITCODE -eq 0) {
        Write-Host "‚úÖ Service installed and started successfully!" -ForegroundColor Green
        Write-Host "üåê Access URL: http://localhost:8000" -ForegroundColor Cyan
        Write-Host "üîë Default password: admin123" -ForegroundColor Cyan
    } else {
        Write-Host "‚ö†Ô∏è Service installed but may not be running properly" -ForegroundColor Yellow
        Write-Host "üí° Check service_error.log for details" -ForegroundColor Yellow
    }
}

function Uninstall-Service {
    if (!(Test-Administrator)) {
        Write-Host "‚ùå Please run this script as Administrator!" -ForegroundColor Red
        exit 1
    }

    $nssmPath = Join-Path $PSScriptRoot "nssm\win64\nssm.exe"

    sc.exe query $ServiceName >$null 2>&1
    if ($LASTEXITCODE -ne 0) {
        Write-Host "‚ö†Ô∏è Service $ServiceName does not exist" -ForegroundColor Yellow
        exit 0
    }

    Write-Host "üóëÔ∏è Uninstalling service..." -ForegroundColor Yellow
    & $nssmPath stop $ServiceName confirm
    Start-Sleep -Seconds 3
    & $nssmPath remove $ServiceName confirm

    Write-Host "‚úÖ Service uninstalled successfully!" -ForegroundColor Green
}

if ($Uninstall) {
    Uninstall-Service
} else {
    Deploy-Service
}

Write-Host ""
Write-Host "Common commands:" -ForegroundColor Cyan
Write-Host "  Start service: nssm start $ServiceName" -ForegroundColor Gray
Write-Host "  Stop service: nssm stop $ServiceName" -ForegroundColor Gray
Write-Host "  Service status: nssm status $ServiceName" -ForegroundColor Gray
'@

        $deployScript | Out-File -FilePath "$distDir/deploy.ps1" -Encoding UTF8

        # Create simple service manager
        $serviceManager = @'
@echo off
:: LanAuthGate Simple Service Manager

set SERVICE_NAME=LanAuthGate
set NSSM_EXE=%~dp0nssm\win64\nssm.exe

if "%1"=="" goto :usage
if "%1"=="start" goto :start
if "%1"=="stop" goto :stop
if "%1"=="restart" goto :restart
if "%1"=="status" goto :status
if "%1"=="remove" goto :remove

:usage
echo.
echo üîß LanAuthGate Service Manager
echo ============================
echo Usage: service.cmd [command]
echo.
echo Commands:
echo   start    - Start the service
echo   stop     - Stop the service
echo   restart  - Restart the service
echo   status   - Show service status
echo   remove   - Remove the service
echo.
goto :end

:start
"%NSSM_EXE%" start %SERVICE_NAME%
goto :end

:stop
"%NSSM_EXE%" stop %SERVICE_NAME%
goto :end

:restart
"%NSSM_EXE%" restart %SERVICE_NAME%
goto :end

:status
"%NSSM_EXE%" status %SERVICE_NAME%
goto :end

:remove
echo üóëÔ∏è Uninstalling service...
"%NSSM_EXE%" stop %SERVICE_NAME% confirm
timeout /t 3 /nobreak >nul
"%NSSM_EXE%" remove %SERVICE_NAME% confirm
goto :end

:end
'@

        $serviceManager | Out-File -FilePath "$distDir/service.cmd" -Encoding ASCII

        # Create batch deployment wrapper
        $batchWrapper = @'
@echo off
:: LanAuthGate Deployment Wrapper

net session >nul 2>&1
if %errorlevel% neq 0 (
    echo ‚ùå Please run this script as Administrator!
    echo üí° Right-click and select "Run as administrator"
    pause
    exit /b 1
)

echo üöÄ Starting LanAuthGate deployment...
powershell -ExecutionPolicy Bypass -File "%~dp0deploy.ps1" %*
pause
'@

        $batchWrapper | Out-File -FilePath "$distDir/deploy.bat" -Encoding ASCII

    - name: Create ZIP archive
      shell: pwsh
      run: |
        $artifactName = "${{ steps.artifact.outputs.artifact-name }}"
        $sourceDir = "dist/windows"
        $zipPath = "dist/${artifactName}.zip"

        # Create ZIP archive
        Compress-Archive -Path "$sourceDir\*" -DestinationPath $zipPath -Force

        # Display archive info
        $archive = Get-Item $zipPath
        Write-Host "Archive created: $($archive.FullName)"
        Write-Host "Archive size: $([math]::Round($archive.Length / 1MB, 2)) MB"

        # List archive contents
        Write-Host "Archive contents:"
        Get-ChildItem -Path $sourceDir -Recurse | ForEach-Object {
            $relativePath = $_.FullName.Substring($sourceDir.Length + 1)
            $size = if ($_.PSIsContainer) { "DIR" } else { "$([math]::Round($_.Length / 1KB, 1)) KB" }
            Write-Host "  $relativePath ($size)"
        }

    - name: Upload build artifacts
      uses: actions/upload-artifact@v4
      with:
        name: ${{ steps.artifact.outputs.artifact-name }}
        path: dist/${{ steps.artifact.outputs.artifact-name-zip }}
        retention-days: 30

    - name: Create Release
      if: startsWith(github.ref, 'refs/tags/v')
      uses: softprops/action-gh-release@v1
      with:
        files: dist/${{ steps.artifact.outputs.artifact-name-zip }}
        name: Release ${{ steps.artifact.outputs.version }}
        body: |
          ## LanAuthGate ${{ steps.artifact.outputs.version }}

          ### üöÄ Quick Start
          1. Download the ZIP file for your platform
          2. Extract to your desired location
          3. Run `deploy.bat` as Administrator
          4. Access http://localhost:8000
          5. Default password: `admin123`

          ### üìã Service Management
          After installation, use `service.cmd`:
          - `service.cmd start` - Start service
          - `service.cmd stop` - Stop service
          - `service.cmd status` - Check status
          - `service.cmd remove` - Uninstall service

          ### üîß Manual Installation
          If automated deployment fails:
          1. Run PowerShell as Administrator
          2. `cd` to extracted directory
          3. Run: `PowerShell -ExecutionPolicy Bypass -File deploy.ps1`

          ### üìä Build Information
          - **Version**: ${{ steps.artifact.outputs.version }}
          - **Platform**: Windows AMD64
          - **Build Type**: ${{ steps.artifact.outputs.build-type }}
          - **Commit**: ${{ github.sha }}
          - **Build Date**: ${{ github.event.head_commit.timestamp || github.event.repository.updated_at }}}
        draft: false
        prerelease: ${{ contains(steps.artifact.outputs.version, 'beta') || contains(steps.artifact.outputs.version, 'alpha') || contains(steps.artifact.outputs.version, 'rc') }}
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

    - name: Test deployment scripts
      shell: pwsh
      run: |
        # Test that PowerShell script syntax is valid
        $scriptPath = "dist/windows/deploy.ps1"
        if (Test-Path $scriptPath) {
          $null = [System.Management.Automation.PSParser]::Tokenize((Get-Content $scriptPath -Raw), [ref]$null)
          Write-Host "‚úÖ PowerShell script syntax is valid" -ForegroundColor Green
        }

        # Test that batch files exist
        $batchFiles = @("deploy.bat", "service.cmd")
        foreach ($file in $batchFiles) {
          $filePath = "dist/windows/$file"
          if (Test-Path $filePath) {
            Write-Host "‚úÖ $file exists" -ForegroundColor Green
          } else {
            Write-Host "‚ùå $file missing" -ForegroundColor Red
          }
        }